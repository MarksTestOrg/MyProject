'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.findBuddybuildBuildTestEvidence = undefined;

var _axios = require('axios');

var _axios2 = _interopRequireDefault(_axios);

var _getCommitHashOfTag = require('./getCommitHashOfTag');

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const BUDDYBUILD_TOKEN = process.env.BUDDYBUILD_TOKEN;

const baseApiUrl = 'https://api.buddybuild.com';

const getJobs = async () => {
  const response = await _axios2.default.get(`${baseApiUrl}/v1/apps`, {
    headers: { Authorization: `Bearer ${BUDDYBUILD_TOKEN}` }
  });
  return response.data;
};

const getBuilds = async jobSlug => {
  const response = await _axios2.default.get(`${baseApiUrl}/v1/apps/${jobSlug}/builds`, {
    headers: { Authorization: `Bearer ${BUDDYBUILD_TOKEN}` }
  });
  return response.data;
};

const findBuddybuildBuildTestEvidence = exports.findBuddybuildBuildTestEvidence = async jobName => {
  const commitHash = await (0, _getCommitHashOfTag.getCommitHashOfTag)();
  const jobs = await getJobs();
  let jobSlug;

  for (const job of jobs) {
    if (job.app_name === jobName) {
      jobSlug = job._id;
    }
  }

  if (!jobSlug) {
    throw new Error(`${jobName} job not found. Please check your release-documentation-cli config file`);
  }

  const builds = await getBuilds(jobSlug);
  const correctBuild = builds.find(build => commitHash === build.commit_info.commit_sha);

  if (correctBuild) {
    const url = `https://dashboard.buddybuild.com/apps/${jobSlug}/build/${correctBuild._id}`;
    return { jobName, status: correctBuild.build_status, url };
  } else {
    throw new Error(`No build found with commit hash: ${commitHash}`);
  }
};